# 🧭 디스코드 서버 **Cody 운영 정책**

> 본 문서는 Cody 디스코드 서버의
> 
> 
> **성장 시스템 · 수급 구조 · 승급 구조 · 채널 설계 의도**를
> 
> 코드로 구현하기 위한 기준 문서이다.
> 

---

## 📈 1. Cody 성장 시스템 개요

Cody 서버는 아래 **3가지 핵심 지표**로 유저의 성장을 관리한다.

- 🧠 **EXP (경험치)** : 체류·활동 시간의 누적 지표
- 🎯 **활동포인트** : 실제 상호작용·기여의 증명 지표
- 💰 **코디 크레딧(CC)** : 보상·소비·재미를 위한 화폐

이 세 지표는 각각 **역할이 명확히 분리**되어 있으며,

단일 지표로는 승급이 불가능하도록 설계한다.

---

## 🧠 2. EXP (경험치) 설계 의도

### 핵심 정체성

👉 **“시간 + 체류의 증명”**

### EXP가 측정하는 것

- 서버에 얼마나 오래 머물렀는가
- 대화에 참여했는가
- 보이스에 참여했는가
- 미디어/활동 채널에 최소한의 참여를 했는가

### 설계 특징

- 💬 자유채팅, 🎧 보이스 등 **저강도 행동에도 지속 누적**
- 📸 미디어 / 📹 활동 채널 참여 시 **가속 수급**
- ❌ EXP 단독으로는 승급 불가 (활동포인트 필수)

➡️ **EXP = 출석 + 체류 기록용 지표**

---

## 🎯 3. 활동포인트 설계 의도

### 핵심 정체성

👉 **“실제 상호작용과 기여의 증명”**

### 활동포인트 지급 기준

- 📹 영상클립
- 🖼️ 게임인증사진
- 🤝 멘토 보상

처럼 **결과물이 명확한 활동**에서만 지급

### 설계 특징

- ❌ 채팅 / ❌ 보이스로는 절대 지급되지 않음
- 반드시 **다른 유저와 함께 했다는 증거(태그)** 필요
- 모든 승급의 핵심 조건

➡️ **활동포인트 = 신뢰도 / 기여도 지표**

---

## 💰 4. 코디 크레딧(CC) 설계 의도

### 핵심 정체성

👉 **“보상·선택·재미를 위한 화폐”**

### 크레딧의 흐름

- 활동 채널에서 가장 많이 수급
- 미디어 / 체류 활동으로 소량 누적
- 멘토 보상에서 대량 획득
- 닉네임 변경, 클랜, 도박, 칭호 등으로 소비

### 설계 특징

- 숫자 단위가 큼 → **체감 강함**
- 등급에 직접 영향 ❌
- 유저가 “어디에 쓸지” 선택

➡️ **코디 크레딧 = 동기 부여용 경제 시스템**

---

## 📊 5. 수급처 통합 표 (최종)

**EXP · 활동포인트 · 코디 크레딧(CC)**

| 구분 | 수급처 | EXP | 활동포인트 | CC | 제한 / 조건 | 비고 |
| --- | --- | --- | --- | --- | --- | --- |
| **활동 채널** | 📹 영상클립 | +300 | +15 | +600 | 하루 2회 / 2인 이상 태그 | 최고 가치 |
|  | 🖼️ 게임인증사진 | +150 | +5 | +300 | 하루 2회 / 2인 이상 태그 | 기본 활동 |
| **미디어** | 📸 하루사진 | +100 | – | +150 | 하루 1회 | 균등 보조 |
|  | 🗣️ 투데이토픽 | +100 | – | +150 | 하루 1회 | 균등 보조 |
|  | 🎵 음악공유 | +100 | – | +150 | 하루 1회 | 균등 보조 |
|  | 🧠 심리테스트 | +100 | – | +150 | 하루 1회 | 균등 보조 |
| **체류 활동** | 💬 자유채팅 | +5 / 1분 | – | +2 / 1분 | 일일 60분 / 1분 쿨타임 | 대화 유지 |
|  | 🎧 보이스 | +4 / 분 | – | +3 / 분 | 일일 120분 / 2인 이상 | 체류 핵심 |
| **성장 보상** | 👥 초대 보상 | +150 | – | +100 | 하루 1명 | 입장 즉시 |
|  | 🤝 멘토 보상 ① | +1,500 | +30 | +2,000 | 멤버 이상 / 평생 3명 | 스타터→멤버 |
|  | 🤝 멘토 보상 ② | +2,500 | +50 | +3,000 | 멤버 이상 / 평생 3명 | 멤버→크루원 |

---

## 📉 6. 일일 수급 구간 요약

| 구간 | EXP | 활동포인트 | CC | 설명 |
| --- | --- | --- | --- | --- |
| **하한** | 250 | 0 | 190 | 미디어 1 + 체류 소량 |
| **중단** | 1,165 | 20 | 1,490 | 활동채널 1회 포함 |
| **상한(풀)** | 2,230 | 40 | 2,980 | 활동·미디어·체류·초대 |

---

## 🤝 7. 멘토 시스템 규칙

### 멘토 자격

- **멤버 계급 이상만 가능**
- 스타터 ❌
- 멘토 지정은 최초 1회

### 보상 제한

- 멘토 보상 ①, ② 각각 **평생 최대 3명**
- 초대 보상은 별도 (하루 1명)

### 지급 조건

- 실제 승급 완료 시 지급
- 7일 이상 활동 없을 경우 지급 ❌
- 승급 직후 탈퇴 시 회수 가능

---

## 📈 8. 승급 시스템 통합 표

| 승급 | 필요 EXP | 필요 활동포인트 | 😴 느림 | 🙂 평균 | ⚡ 최단 |
| --- | --- | --- | --- | --- | --- |
| 🐣 → 🔰 멤버 | 2,500 | 30 | 7~10일 | 2~3일 | 1~2일 |
| 🔰 → ⭐ 크루원 | 10,000 | 120 | 25~30일 | 6~8일 | 3~4일 |
| ⭐ → 🧠 코어 | 35,000 | 300 | 60~70일 | 18~22일 | 8~10일 |

---

## 📂 9. 채널 카테고리 설계 의도

### 🔥 활동 채널

- 서버에서 **가장 잘 보이고 활성화되어 보이는 카테고리**
- 활동포인트 + 고수익 CC 지급
- 영상클립 > 게임인증사진 가치 구조

### 🌐 미디어

- 진입 장벽 낮은 참여형 콘텐츠
- EXP + CC만 지급
- 하루 1회 제한으로 남용 방지

---

## 🧠 최종 설계 핵심 요약

- EXP = 체류
- 활동포인트 = 기여
- 크레딧 = 보상
- **세 지표는 절대 대체 불가**
- 승급은 “시간 + 기여”를 모두 요구
- 멘토는 특권이자 고급 보상 구조

---

# Cody 보상 시스템 구현 명세서 (자연어 버전)

## 목적

Cody 서버의 보상(EXP/활동포인트/CC)은 **어뷰징(꼼수)**, **중복지급**, **부분지급 버그**, **분쟁(“왜 저 사람은 됐냐”)**를 최대한 막는 구조로 구현한다.

---

## 1) 활동포인트 지급은 “한 번에 처리”해야 한다 (트랜잭션)

### 왜 필요한가

활동 채널(영상클립/게임인증사진)은 보상 가치가 크다.

여기서 가장 자주 터지는 문제가 3가지다.

- 중복 제출로 보상이 여러 번 들어감
- 조건 미달인데 일부만 지급됨 (예: EXP만 들어가고 포인트는 안 들어감)
- 지급 중 오류가 나서 데이터가 꼬임

그래서 **검증 → 지급 → 기록을 한 덩어리로 묶어서** “성공 아니면 전부 취소”로 처리해야 한다.

### 어떤 기능이 필요하나

활동 채널 글 1개가 올라오면, 시스템은 아래를 반드시 한다.

1. **태그 검증**
- 활동포인트는 “혼자 한 활동”에는 지급하지 않는다.
- 글에 **다른 유저 1명 이상이 태그되어 있어야** 한다. (2인 이상 활동 증거)
- 봇 계정 태그/존재하지 않는 유저/본인만 태그 → 실패 처리
1. **중복 체크**
- 같은 글(message_id)로 보상을 **이미 지급한 적이 있으면** 다시 지급하면 안 된다.
- 즉, “이 메시지는 처리 완료”라는 기록이 존재하면 **무조건 실패**.
1. **하루 제한 체크**
- 영상클립: 하루 2회
- 게임인증사진: 하루 2회
- 오늘 기준은 서버 시간(KST)으로 00:00~23:59
1. **지급 처리**
- 조건을 모두 통과하면 보상을 지급한다.
    - EXP / 활동포인트 / CC를 정책표에 맞춰 증가
- 동시에 “이 글은 지급 완료” 상태로 저장한다.
1. **로그 기록**
- 지급한 근거가 남아야 한다.
- “누가, 어떤 글로, 어떤 타입으로, 얼마를 받았는지”를 로그에 기록한다.

### 반드시 지켜야 하는 동작 규칙 (중요)

- 위 1~5는 **중간에 하나라도 실패하면 전부 취소**되어야 한다.
- 예: 태그 검증 실패 → EXP도, 포인트도, CC도 0원(0점)
- 예: DB 오류 → 아무것도 지급되면 안 됨

> 쉽게 말해: “성공이면 전부 지급 + 전부 기록”, “실패면 아무 것도 안 바뀜”
> 

---

## 2) EXP/CC 시간 수급은 “서버가 판단”해야 한다 (클라 타이머 금지)

### 왜 필요한가

채팅/보이스는 시간이 길면 길수록 보상이 쌓인다.

여기서 클라이언트(유저 PC/폰)가 시간을 계산해서 보내게 만들면 어뷰징이 열린다.

- 매크로로 “활동한 척” 만들기
- 시간 데이터 조작
- 중복 이벤트로 과다 지급

그래서 “시간이 지났다”는 판단을 **서버가 직접** 해야 한다.

### 어떤 기능이 필요하나

### A) 채팅 보상(자유채팅)

정책:

- EXP: +5 / 1분
- CC: +2 / 1분
- 1분 쿨타임
- 일일 최대 60분까지만 지급

서버가 해야 하는 일:

- 유저가 메시지를 보내면, 서버는 “이 유저의 마지막 채팅 보상 지급 시각”을 확인한다.
- 마지막 지급 후 60초 이상 지났으면 1분치 지급한다.
- 오늘 이미 60분치를 받았으면 더 이상 지급하지 않는다.

핵심:

- 유저가 메시지를 100개 보내도 **1분에 1번만** 지급
- “오늘 받을 수 있는 최대치”를 넘기면 **0 지급**

### B) 보이스 보상

정책:

- EXP: +4 / 분
- CC: +3 / 분
- 일일 최대 120분
- 2인 이상일 때만 인정

서버가 해야 하는 일:

- 유저가 보이스에 들어가도 “혼자면” 보상 없음
- 같은 채널에 사람이 2명 이상인 시간만 분 단위로 인정
- 1분마다 서버가 체크해서 지급(또는 동일한 안정 방식)

핵심:

- “보이스 접속만 했다”로는 안 됨
- “2인 이상이 유지된 시간”만 쌓임

---

## 3) 로그는 처음부터 분리해서 남겨야 한다 (원장 구조)

### 왜 필요한가

운영하다 보면 거의 무조건 이런 상황이 온다.

- “쟤 왜 승급됐어요?”
- “저는 포인트 받았는데 왜 롤백됐어요?”
- “거래했는데 크레딧이 이상해요”
- “아이템 썼는데 소모만 됐어요”

이때 로그가 없으면 운영자는 **증명할 방법이 없고**, 시스템 신뢰가 무너진다.

그래서 총합(현재 보유 EXP/포인트/CC)과 별개로

**“무슨 이유로 얼마가 변했는지” 기록(로그/원장)을 반드시 남긴다.**

### 어떤 로그가 필요한가 (최소)

- `exp_log` : EXP가 언제/왜/얼마 변했는지
- `activity_point_log` : 활동포인트가 언제/왜/얼마 변했는지
- `credit_log` : CC가 언제/왜/얼마 변했는지
- `item_use_log` : 아이템 사용 성공/실패 + 실패 사유
- `trade_log` : 거래 기록(누가 누구에게 무엇을 얼마에)

### 로그에 반드시 들어가야 하는 공통 정보

- 누구(user)
- 언제(time)
- 무엇 때문에(source: 채팅/보이스/활동/미디어/멘토/거래/아이템 등)
- 근거 ID(가능하면 message_id, trade_id 같은 추적 키)
- 변화량(+ / -)

핵심:

- 총합 수치는 “현재 상태”이고,
- 로그는 “왜 그렇게 됐는지”를 증명하는 근거다.

---

## 최종 구현 원칙 3줄 요약

1. **활동 채널 보상은 “검증+지급+기록”을 한 번에 처리한다. 실패하면 아무 것도 바뀌면 안 된다.**
2. **시간 보상(채팅/보이스)은 서버가 직접 판단한다. 유저 기기에서 계산한 시간은 믿지 않는다.**
3. **모든 변화는 로그로 남겨서 나중에 증명 가능하게 한다.**

---

# 🧭 Cody 계급 시스템 설계 문서 (최종 정리본)

## 🐣 스타터 (Starter)

### 🎯 계급 정체성

- **관찰자 · 적응 단계**
- 서버 분위기를 파악하고 사람을 익히는 단계
- 서버에 대한 기여를 아직 요구하지 않음

### ✅ 가능 권한

- 💬 자유채팅 참여
- 🎧 보이스 채널 이용
- 📸 하루사진 / 🗣️ 투데이토픽 / 🎵 음악공유 / 🧠 심리테스트 참여
- 🖼️ 게임인증사진 / 📹 영상클립 업로드 가능
- 🧠 EXP / 💰 코디 크레딧 기본 수급 가능

### ❌ 제한 사항 (의도적)

- 멘토 역할 불가
- 클랜 가입 / 생성 불가
- 커플 시스템 이용 불가
- 서버 운영·의사결정 관련 기능 접근 불가

### 🧩 운영 의도

- 진입 장벽 최소화
- “일단 들어와서 놀아보세요” 단계
- 활동포인트 수급은 가능하지만 **승급 압박은 없음**

---

## 🔰 멤버 (Member)

### 🎯 계급 정체성

- **정식 서버 구성원**
- 서버에 정착했고, 함께 놀 사람으로 인정된 단계
- 스타터의 정착을 돕는 역할 시작

### ✅ 가능 권한

- 🐣 스타터 권한 전부
- 👥 클랜 가입 가능
- 🛡️ 클랜 부운영자 역할 가능
- 💞 커플 시스템 이용 가능
- 💰 코디 크레딧 거래 / 내기 / 도박 / 아이템 거래 가능
- 🎯 이벤트 참여 및 보상 수령 가능
- 닉네임 장식권 / 닉네임 변경 쿨타임 해제권 사용 가능

### ❌ 제한 사항

- 클랜 생성 불가
- 서버 운영 권한 없음
- 관리자·운영 보조 역할 불가

### 🧩 운영 의도

- 서버의 **주 활동층**
- 가장 많은 유저가 머무는 핵심 계급
- 멘토 시스템을 통한 **자연스러운 신규 유입 유도**
- “이 서버 사람이다”라는 소속감 형성

---

## ⭐ 크루원 (Crew)

### 🎯 계급 정체성

- **서버 분위기를 만드는 핵심 인원**
- 신입에게 가장 많이 노출되는 얼굴
- 서버 문화 유지의 중심축

### ✅ 가능 권한

- 🔰 멤버 권한 전부
- 🏳️ 클랜 생성 가능
- 🤝 멘토 보상 ①·② 모두 수급 가능 (고수익 구간)
- 🎤 이벤트 보조 진행 가능
- 📌 일부 게시판 관리 보조(제한적)

### ❌ 제한 사항

- 최종 운영 결정권 없음
- 강제 제재 권한 없음

### 🧩 운영 의도

- 서버를 실제로 굴리는 실무층
- “이 서버는 이런 분위기다”를 보여주는 기준점
- 멘토 · 클랜 · 활동 채널의 중심 허브

---

## 🧠 코어 (Core)

### 🎯 계급 정체성

- **서버 신뢰 기반 핵심 인력**
- 운영진과 동일한 방향성을 공유하는 계급
- 단순 활동량이 아닌 **지속성 + 신뢰의 결과**

### ✅ 가능 권한

- ⭐ 크루원 권한 전부
- 🛠️ 고위 운영진 지원 가능
- 📣 규칙 안내 및 분쟁 중재
- 🎯 이벤트 기획 및 제안
- 🧩 신규 시스템 테스트 참여
- 🎨 닉네임 그라데이션 색상 적용 가능

### ❌ 제한 사항

- 최종 제재 권한(차단·강퇴)은 운영진 전용

### 🧩 운영 의도

- 고인물 보상 계급
- 서버를 맡겨도 되는 사람의 기준선
- 운영진과 유저 사이의 완충 계층

---

## 🔄 계급 흐름 요약

| 단계 | 한 줄 정의 |
| --- | --- |
| 🐣 스타터 | 구경하고 적응 |
| 🔰 멤버 | 같이 노는 사람 |
| ⭐ 크루원 | 분위기를 만드는 사람 |
| 🧠 코어 | 서버를 지키는 사람 |

---

## 🔑 설계 핵심 원칙

> 권한은 계단식
> 
> 
> **책임은 단계별**
> 
> **보상은 체감되게**
> 
- 활동만으로는 최상위에 갈 수 없음
- 신뢰와 지속성이 반드시 필요
- 어느 단계에 있어도 “할 이유”가 존재하도록 설계

---

# 📑 Cody 아이템 성공·실패 표준 메시지 명세서 v1

> 목적
> 
> - 아이템 사용 UX 통일
> - 실패 사유 명확화
> - 로그/CS 대응 용이
> - 커서 AI 구현 기준 제공

---

## 1️⃣ 기본 원칙 (중요)

### ✅ 성공 메시지 원칙

- 아이템 **소모 완료**
- 효과 **정상 적용**
- 짧고 확정적인 문장
- 감정 표현 최소화

### ❌ 실패 메시지 원칙

- **아이템 소모 없음**
- 실패 사유 **1가지 명확히 표시**
- 해결 방법 암시 가능
- 책임 주체 명확 (권한 / 조건 / 상태)

---

## 2️⃣ 공통 메시지 포맷

### ✅ 성공 기본 포맷

```
✅ {아이템명}이(가) 성공적으로 적용되었습니다.

```

### ✅ 성공 확장 포맷 (정보 필요 시)

```
✅ {아이템명}이(가) 적용되었습니다.
{추가 안내1줄}

```

> ⚠️ 최대 2줄, 이모지 1개 이내
> 

---

### ❌ 실패 기본 포맷

```
❌ {아이템명}을(를) 사용할 수 없습니다.
사유: {실패 사유}

```

---

## 3️⃣ 실패 사유 표준 코드 (중요)

> ❗ 실패 메시지는 반드시 아래 사유 중 하나 사용
> 

| 코드 | 실패 사유 문구 |
| --- | --- |
| `RANK_LIMIT` | 계급 조건을 충족하지 않았습니다. |
| `NO_ITEM` | 해당 아이템을 보유하고 있지 않습니다. |
| `COOLDOWN` | 아직 사용할 수 없는 상태입니다. |
| `INVALID_TARGET` | 대상이 유효하지 않습니다. |
| `NOT_OWNER` | 권한이 없는 대상입니다. |
| `STATE_MISMATCH` | 현재 상태에서는 사용할 수 없습니다. |
| `LIMIT_REACHED` | 사용 가능 횟수를 초과했습니다. |
| `DEPENDENCY` | 선행 조건이 충족되지 않았습니다. |
| `SYSTEM_ERROR` | 시스템 오류가 발생했습니다. |

---

## 4️⃣ 아이템 유형별 성공·실패 메시지 명세

---

## Ⅰ. 닉네임 관련 아이템

### 1) 닉네임 변경권

### ✅ 성공

```
✅ 닉네임이 성공적으로 변경되었습니다.
다음 변경은 14일 후 가능합니다.

```

### ❌ 실패

- 계급 부족

```
❌ 닉네임 변경권을 사용할 수 없습니다.
사유: 계급 조건을 충족하지 않았습니다.

```

- 쿨타임

```
❌ 닉네임 변경권을 사용할 수 없습니다.
사유: 아직 사용할 수 없는 상태입니다.

```

---

### 2) 닉네임 변경 쿨타임 해제권

### ✅ 성공

```
✅ 닉네임 변경 쿨타임이 초기화되었습니다.

```

### ❌ 실패

- 단독 사용 시

```
❌ 닉네임 변경 쿨타임 해제권을 사용할 수 없습니다.
사유: 선행 조건이 충족되지 않았습니다.

```

---

### 3) 닉네임 장식권 (앞/뒤)

### ✅ 성공

```
✅ 닉네임 장식이 적용되었습니다.

```

### ❌ 실패

- 이미 장식 존재

```
❌ 닉네임 장식권을 사용할 수 없습니다.
사유: 이미 적용된 장식이 있습니다.

```

---

## Ⅱ. 역할(Role) 관련 아이템

### 5) 시즌 한정 역할

### ✅ 성공

```
✅ 시즌 한정 역할이 부여되었습니다.

```

### ❌ 실패

- 시즌 종료

```
❌ 시즌 한정 역할을 사용할 수 없습니다.
사유: 현재 시즌이 종료되었습니다.

```

---

### 6) 대명사 역할권

### ✅ 성공

```
✅ 선택한 역할이 적용되었습니다.

```

### ❌ 실패

```
❌ 대명사 역할권을 사용할 수 없습니다.
사유: 현재 상태에서는 사용할 수 없습니다.

```

---

## Ⅲ. 커플 시스템 아이템

### 7) 커플 전용 음성 채널

### ✅ 성공

```
✅ 커플 전용 음성 채널이 생성되었습니다.

```

### ❌ 실패

- 커플 아님

```
❌ 커플 전용 음성 채널을 생성할 수 없습니다.
사유: 현재 커플 상태가 아닙니다.

```

---

### 8) 커플 역할 이름 변경권

### ✅ 성공

```
✅ 커플 역할 이름이 변경되었습니다.

```

### ❌ 실패

```
❌ 커플 역할 이름 변경권을 사용할 수 없습니다.
사유: 대상이 유효하지 않습니다.

```

---

## Ⅳ. 클랜 시스템 아이템

### 9) 클랜 생성권

### ✅ 성공

```
✅ 클랜이 성공적으로 생성되었습니다.

```

### ❌ 실패

- 이미 소속

```
❌ 클랜 생성권을 사용할 수 없습니다.
사유: 이미 클랜에 소속되어 있습니다.

```

---

### 10) 클랜명 변경권

### ✅ 성공

```
✅ 클랜 이름이 변경되었습니다.

```

### ❌ 실패

```
❌ 클랜명 변경권을 사용할 수 없습니다.
사유: 권한이 없는 대상입니다.

```

---

### 11) 클랜 정원 1명 늘리기권

### ✅ 성공

```
✅ 클랜 정원이 1명 증가했습니다.

```

### ❌ 실패

```
❌ 클랜 정원 늘리기권을 사용할 수 없습니다.
사유: 사용 가능 횟수를 초과했습니다.

```

---

## Ⅴ. 도박 / 랜덤 아이템

### 14) 크레딧 홀짝권

### ✅ 성공 (승리)

```
🎉 결과: 승리
보상이 지급되었습니다.

```

### ✅ 성공 (패배)

```
결과: 패배
보상이 지급되지 않았습니다.

```

> ⚠️ 패배도 성공 처리 (아이템 소모 O)
> 

---

### 15) 랜덤 박스

### ✅ 성공

```
🎁 랜덤 박스를 열었습니다.
보상: {아이템명}

```

---

## Ⅵ. 채널 관련 아이템

### 17) 개인 음성방 생성권

### ✅ 성공

```
✅ 개인 음성방이 생성되었습니다.

```

### ❌ 실패

```
❌ 개인 음성방 생성권을 사용할 수 없습니다.
사유: 이미 생성된 음성방이 있습니다.

```

---

## 5️⃣ 개발 공통 응답 구조 (권장)

```json
{
"success":false,
"errorCode":"RANK_LIMIT",
"message":"❌ 닉네임 변경권을 사용할 수 없습니다.\n사유: 계급 조건을 충족하지 않았습니다.",
"itemConsumed":false
}

```

---

## 6️⃣ 핵심 요약 (운영 관점)

- 성공 = 조용하고 확실하게
- 실패 = 이유를 명확하게
- 아이템은 **소모 기준이 명확**
- CS 대응 시 메시지 그대로 안내 가능

---

# ✅ useItem 공통 처리 플로우 (의사코드)

> 원칙: 권한/조건 불충족이면 절대 소모하지 않는다.
> 
> 
> 순서: **권한체크 → 보유체크 → 상태/제약체크 → (트랜잭션) 소모 → 효과적용 → 로그 → 응답**
> 

# ✅ 아이템 거래 성공·실패 메시지 표준 (명세서 v1)

> 원칙
> 
> - 거래 실패 시 **크레딧/아이템 이동 없음**
> - 거래 성공 시 **양쪽 모두에게 메시지**(ephemeral 권장)
> - 실패 사유는 **1개만** 노출

## 3) 거래 실패 표준 문구

### ❌ 실패 (구매자)

```
❌ 거래를 완료할 수 없습니다.
사유: {실패 사유}

```

### ❌ 실패 (판매자) — 필요 시만

```
❌ 거래가 취소되었습니다.
사유: {실패 사유}

```

## 2) 거래 실패 사유 표준 코드

| 코드 | 실패 사유 문구 |
| --- | --- |
| `NO_ITEM` | 판매자가 해당 아이템을 보유하고 있지 않습니다. |
| `NO_FUNDS` | 코디 크레딧이 부족합니다. |
| `LISTING_NOT_FOUND` | 거래 항목을 찾을 수 없습니다. |
| `LISTING_EXPIRED` | 거래 시간이 만료되었습니다. |
| `LISTING_ALREADY_DONE` | 이미 처리된 거래입니다. |
| `SELF_TRADE` | 본인에게는 거래할 수 없습니다. |
| `RANK_LIMIT` | 계급 조건을 충족하지 않았습니다. |
| `LIMIT_REACHED` | 거래 제한에 도달했습니다. |
| `SYSTEM_ERROR` | 시스템 오류가 발생했습니다. |
|  |  |

# 📌 Cody 전체 시스템 플로우 다이어그램용 텍스트 v2.1

*(승급 · 멘토 · 회수 · 채널별 로그 반영)*

---

## 공통 전제 (업데이트)

- 모든 로그는 **“행위가 발생한 게시판(채널)” 기준으로 기록**한다.
- 따라서 **모든 로그에는 `channel_id`가 필수**이다.
- 시간/일일 제한 기준: **KST 00:00 리셋**
- 실패 시: 상태 변화 없음 + **ephemeral 실패 메시지**
- 트랜잭션으로 묶인 구간은 **원자 처리**

---

## 0) 이벤트 진입점(Trigger) — 수정 없음

1. ACTIVITY_SUBMIT
2. MEDIA_SUBMIT
3. CHAT_PING
4. VOICE_TICK
5. INVITE_REWARD
6. RANK_CHECK
7. **MENTOR_ASSIGN_ON_JOIN (신규)**
8. ADMIN_INVALIDATE_ACTIVITY
9. CONTENT_DELETE_DETECTED

---

## 1️⃣ 멘토 지정 플로우 (가입 시점) — 구조 변경됨

### 1-1. 트리거

- 유저 서버 **최초 가입 시**
- 또는 `/멘토지정 {유저이름}` 명령어 실행 시
- `/멘토지정 없음` 선택 가능

---

### 1-2. 입력

- mentee_user_id
- mentor_user_id OR `NONE`
- guild_id
- channel_id (시스템 안내 채널 또는 가입 채널)

---

### 1-3. 검증 단계

1. **이미 멘토가 지정되어 있는지**
- mentee가 mentor_id를 이미 보유 → FAIL(LIMIT_REACHED)
1. **멘토 지정 없음 선택**
- mentor_user_id = NONE
    
    → mentor_id = null 로 확정 저장
    
    → 이후 변경 불가
    
1. **멘토 계급 검증**
- mentor_user_id의 계급이 **멤버 이상**인지 확인
- 아니면 → FAIL(RANK_LIMIT)
1. **멘토 멘티 수 제한 검증 (중요 추가)**
- mentor_user_id의 멘티 수 ≥ 3명
    
    → FAIL(LIMIT_REACHED)
    

---

### 1-4. 트랜잭션

**[TRANSACTION: MentorAssignOnJoin]**

1. mentee.profile.mentor_id 저장
2. mentor_bind_log 기록
    - mentee_user_id
    - mentor_user_id or NONE
    - channel_id
    - created_at
        
        **[COMMIT]**
        

---

### 1-5. 결과

- 성공: “멘토 지정 완료” 안내(옵션)
- 실패: ephemeral 실패 메시지

---

## 2️⃣ 활동 채널 보상 플로우 (ACTIVITY_SUBMIT) — 로그 확장

### 2-1. 입력

- guild_id
- channel_id
- message_id
- submitter_user_id
- activity_type
- tagged_user_ids[]
- content_url

---

### 2-2. 검증 단계 (변경 없음 + 스타터 조건 유지)

- 채널 검증
- 태그 유효성 검증
- **태그된 유저 중 스타터 1명 이상 포함**
- 일일 제한
- 중복 처리 여부

---

### 2-3. 트랜잭션

**[TRANSACTION: ActivityReward]**

1. activity_submissions 기록
    - channel_id 포함
2. 보상 계산
    - 작성자 + 참여자 모두
3. wallet 업데이트
4. 로그 기록 (중요 변경)
    - exp_log
    - activity_point_log
    - credit_log
        
        **→ 모두 channel_id 저장**
        
5. activity_submissions.status = APPROVED
    
    **[COMMIT]**
    

---

### 2-4. 후처리

- RANK_CHECK 호출(작성자 + 참여자)

---

## 3️⃣ 미디어 보상 플로우 (MEDIA_SUBMIT) — 로그에 channel_id 포함

### 트랜잭션

**[TRANSACTION: MediaReward]**

- wallet(exp, cc)
- exp_log / credit_log
    - channel_id 포함
        
        **[COMMIT]**
        

---

## 4️⃣ 채팅 보상 플로우 (CHAT_PING) — 게시판 로그화

### 트랜잭션

**[TRANSACTION: ChatMinuteReward]**

- wallet(exp, cc)
- exp_log / credit_log
    - channel_id = 채팅 발생 채널
        
        **[COMMIT]**
        

---

## 5️⃣ 보이스 보상 플로우 (VOICE_TICK)

### 트랜잭션

**[TRANSACTION: VoiceMinuteRewardBatch]**

- wallet(exp, cc)
- exp_log / credit_log
    - channel_id = 보이스 채널 ID
        
        **[COMMIT]**
        

---

## 6️⃣ 자동 승급 + 멘토 보상 플로우 (RANK_CHECK) — 멘토 조건 반영

### 6-1. 조건 판단

- EXP 조건
- 활동포인트 조건

---

### 6-2. 트랜잭션

**[TRANSACTION: RankUpAndMentorReward]**

1. 승급 조건 재검증
2. rank 업데이트
3. rank_log 기록
    - channel_id = 승급 트리거가 된 채널
4. 멘토 보상 판단
- mentor_id 존재 여부
- 멘토 계급 ≥ 멤버
- 멘토 보상 횟수 제한(①/② 각 3명)
- 멘티 활동 조건 충족 여부
1. 멘토 보상 지급
- mentor wallet 업데이트
- mentor_reward_log 기록
    - channel_id 포함

**[COMMIT]**

---

## 7️⃣ 보상 회수 / 무효화 플로우 — 게시판 기반 추적

### 트랜잭션

**[TRANSACTION: RevokeRewards]**

1. activity_submissions 조회 (channel_id 포함)
2. 지급 로그 조회
3. wallet 차감
4. exp_log / point_log / credit_log
    - source_type = REVOCATION
    - channel_id 유지
5. activity_submissions.status = REVOKED
6. revoke_log 기록
    
    **[COMMIT]**
    

---

## 8️⃣ 로그 시스템 최종 규칙 (확정)

### 모든 로그 공통 필드

- user_id
- delta 값
- source_type
- source_id
- **channel_id**
- created_at

> 로그는 “무슨 게시판에서 무슨 일이 일어났는지”까지 추적 가능해야 한다.
> 

---

## 🔚 최종 END 상태

- END: SUCCESS
- END: FAIL (ephemeral)
- END: NO-OP (정책상 조용히 무시)

---

### 거래 관련 추가 규칙(초안, 개발 참고)

- **거래 가능**: 전 아이템 ✅
- 권장 구현(간단):
    - 아이템은 “수량형(inventory)”으로만 관리
    - 거래는 “아이템 → 아이템”이 아니라 **“아이템 ↔ CC”** 형태가 관리 쉬움
    - 거래 로그 필수: `trades(from_user, to_user, item_key, qty, cc_amount, created_at)`